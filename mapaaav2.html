<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>Mapa Apocalipsis en Tiempo Real</title>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0" />
    <meta name="apple-mobile-web-app-capable"
          content="yes">

    <!-- Leaflet -->
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Leaflet Draw -->
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
    <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>

    <link rel="stylesheet"
          href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>


    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        html,
        body,
        #map {
            margin: 0;
            height: 100%;
            overscroll-behavior: none;
            touch-action: none;
            overscroll-behavior-x: none;
            touch-action: pan-y;


        }

        .filtered-tile {
            filter: grayscale(100%) brightness(60%) contrast(140%) hue-rotate(30deg) sepia(40%) saturate(130%) blur(0.3px);
        }

        #panel {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            max-height: 40%;
            overflow-y: auto;
            background: rgba(20, 20, 20, 0.95);
            color: white;
            padding: 10px;
            font-family: sans-serif;
            z-index: 1000;
        }

        #add-controls {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 10px;
            gap: 5px;
        }

        .character-entry {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #333;
            padding: 4px 8px;
            margin: 4px 0;
            border-radius: 4px;
        }

        .character-entry span {
            flex: 1;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        button {
            cursor: pointer;
        }

        .marker-label {
            background: black;
            color: white;
            padding: 2px 3px;
            font-size: 8px;
            border-radius: 2px;
        }

        #blood-frame {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: url('marco.png') no-repeat center center;
            background-size: cover;
            z-index: 999;
            opacity: 0.2;
        }

        .leaflet-bar .pencil-tools .pencil-color {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px;
            background: white;
        }

        .pencil-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 1px solid #888;
            cursor: pointer;
        }

        .pencil-color.white {
            background: white;
        }

        .pencil-color.black {
            background: black;
        }

        .pencil-color.red {
            background: red;
        }

        .leaflet-bar a.custom-pencil.active {
            background-color: #ddd;
        }

        .pencil-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: white;
            padding: 0px;
        }

        .color-selector {
            display: none;
            /* Oculto por defecto */
            flex-direction: column;
            align-items: center;
            gap: 4px;
            margin-top: 4px;
        }

        #panel-toggle-container {
            position: absolute;
            top: 52px;
            /* justo debajo del buscador */
            right: 10px;
            /* üëà lo posiciona hacia la derecha */
            z-index: 1001;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 4px;
            padding: 2px 6px;
        }

        #toggle-panel {
            background: none;
            border: none;
            color: white;
            font-size: 12px;
            cursor: pointer;
            padding: 2px 4px;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <div id="blood-frame"></div>


    <div id="panel-toggle-container">
        <button id="toggle-panel">Pjs</button>
    </div>
    <div id="panel">
        <div id="add-controls">
            <input type="text"
                   id="name"
                   placeholder="Nombre del personaje" />
            <input type="color"
                   id="color"
                   value="#ff0000" />
            <button onclick="addCharacter()">Agregar pj</button>
        </div>
        <div id="character-list"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCP1VddmMF11_QwZGMx6ILHbOpSVhYIMk4",
            authDomain: "mapaj-6017a.firebaseapp.com",
            projectId: "mapaj-6017a",
            storageBucket: "mapaj-6017a.firebasestorage.app",
            messagingSenderId: "411493901671",
            appId: "1:411493901671:web:5e732ecacbb43226a4fbc2"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const charactersRef = db.collection("characters");
        const drawingsRef = db.collection("drawings");


        const map = L.map('map', {
            center: [36.8529300, -75.9779900],
            zoom: 4,
            minZoom: 4,
            zoomControl: false,
            zoomSnap: 2,
            preferCanvas: false,
            attributionControl: false
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; Stadia Maps, OpenMapTiles & OpenStreetMap contributors',
            className: 'filtered-tile'
        }).addTo(map);

        const markers = {};
        const characterEntries = {};


        let searchLayer;

        L.Control.geocoder({
            defaultMarkGeocode: false
        })
            .on('markgeocode', function (e) {
                const placeName = e.geocode.name;

                const url = `https://nominatim.openstreetmap.org/search?format=geojson&polygon_geojson=1&q=${encodeURIComponent(placeName)}`;

                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        if (data.features.length > 0) {
                            const feature = data.features[0];

                            // Elimina capa anterior
                            if (searchLayer) {
                                map.removeLayer(searchLayer);
                            }

                            // Dibuja solo el borde blanco
                            searchLayer = L.geoJSON(feature.geometry, {
                                style: {
                                    color: 'black',
                                    weight: 1,
                                    fillOpacity: 0
                                }
                            }).addTo(map);

                            map.fitBounds(searchLayer.getBounds());
                        } else {
                            alert('No se encontr√≥ el territorio.');
                        }
                    });
            })
            .addTo(map);

        function renderCharacter(doc) {
            const data = doc.data();
            const id = doc.id;

            if (!markers[id]) {
                const markerHtml = document.createElement('div');
                markerHtml.style.backgroundColor = data.color;
                markerHtml.style.width = '20px';
                markerHtml.style.height = '20px';
                markerHtml.style.borderRadius = '50%';
                markerHtml.style.border = '2px solid black';
                markerHtml.style.position = 'relative';

                const label = document.createElement('div');
                label.className = 'marker-label';
                label.textContent = data.name;
                label.style.position = 'absolute';
                label.style.top = '-20px';
                label.style.left = '-10px';
                markerHtml.appendChild(label);

                const icon = L.divIcon({ html: markerHtml.outerHTML, className: '' });
                const marker = L.marker([data.lat, data.lng], { icon: icon, draggable: true }).addTo(map);

                marker.on('dragend', function (e) {
                    const pos = e.target.getLatLng();
                    charactersRef.doc(id).update({ lat: pos.lat, lng: pos.lng });
                });

                markers[id] = marker;
            } else {
                markers[id].setLatLng([data.lat, data.lng]);
            }

            if (!characterEntries[id]) {
                const entry = document.createElement('div');
                entry.className = 'character-entry';
                entry.id = `entry-${id}`;
                entry.innerHTML = `
          <span>${data.name}</span>
          <button onclick="locateCharacter('${id}')">üìç</button>
          <button onclick="deleteCharacter('${id}')">‚ùå</button>
        `;
                document.getElementById('character-list').appendChild(entry);
                characterEntries[id] = entry;
            } else {
                characterEntries[id].querySelector('span').textContent = data.name;
            }
        }

        function locateCharacter(id) {
            if (markers[id]) {
                map.setView(markers[id].getLatLng(), 17);
            }
        }

        function deleteCharacter(id) {
            charactersRef.doc(id).delete();
        }

        charactersRef.onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                const id = change.doc.id;
                if (change.type === 'added' || change.type === 'modified') {
                    renderCharacter(change.doc);
                } else if (change.type === 'removed') {
                    if (markers[id]) {
                        map.removeLayer(markers[id]);
                        delete markers[id];
                    }
                    if (characterEntries[id]) {
                        characterEntries[id].remove();
                        delete characterEntries[id];
                    }
                }
            });
        });

        function addCharacter() {
            const name = document.getElementById('name').value || 'Sin nombre';
            const color = document.getElementById('color').value;
            const center = map.getCenter();
            charactersRef.add({
                name: name,
                color: color,
                lat: center.lat,
                lng: center.lng
            });
            document.getElementById('name').value = '';
        }

        // === Leaflet Draw ===
        const drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        drawingsRef.get().then(snapshot => {
            snapshot.forEach(doc => {
                const data = doc.data();

                const layer = L.geoJSON(data.geometry, {
                    style: data.style,
                    pointToLayer: (feature, latlng) => {
                        return L.circleMarker(latlng, data.style);
                    }
                });

                layer.eachLayer(l => {
                    drawnItems.addLayer(l);
                });
            });
        });



        const drawControl = new L.Control.Draw({
            draw: {
                polygon: false,
                polyline: false,
                marker: false,
                circlemarker: false,
                rectangle: { shapeOptions: { color: '#ffbb00' } },
                circle: { shapeOptions: { color: '#00cc99' } }
            },
            edit: {
                featureGroup: drawnItems,
                remove: true
            }
        });
        map.addControl(drawControl);

        map.on(L.Draw.Event.CREATED, function (e) {
            const layer = e.layer;
            drawnItems.addLayer(layer);

            const geojson = layer.toGeoJSON();

            drawingsRef.add({
                type: "draw",
                geometry: geojson.geometry,
                style: {
                    color: layer.options.color || "#000000",
                    weight: layer.options.weight || 2,
                    fillOpacity: layer.options.fillOpacity || 0.2
                },
            });
        });

        // === L√°piz personalizado ===
        let isDrawing = false;
        let currentLine = null;
        let selectedColor = 'black'; // Color por defecto

        const PencilControl = L.Control.extend({
            options: { position: 'topleft' },
            onAdd: function () {
                const wrapper = L.DomUtil.create('div', 'leaflet-bar pencil-wrapper');

                const button = L.DomUtil.create('a', 'custom-pencil', wrapper);
                button.innerHTML = '‚úèÔ∏è';
                button.href = '#';
                button.style.backgroundColor = selectedColor;

                // Contenedor de los colores
                const colorSelector = L.DomUtil.create('div', 'color-selector', wrapper);

                ['black', 'white', 'red'].forEach(color => {
                    const colorBtn = L.DomUtil.create('div', `pencil-color ${color}`, colorSelector);
                    colorBtn.onclick = () => {
                        selectedColor = color;
                        button.style.backgroundColor = color; // üëà cambia el color del bot√≥n l√°piz
                    };
                });

                // Comportamiento al hacer clic en el l√°piz
                button.onclick = function (e) {
                    e.preventDefault();
                    if (button.classList.contains('active')) {
                        button.classList.remove('active');
                        colorSelector.style.display = 'none';
                        disablePencil();
                        button.style.backgroundColor = selectedColor; // üîÅ vuelve al color original
                    } else {
                        button.classList.add('active');
                        colorSelector.style.display = 'flex';
                        button.style.backgroundColor = "selectedColor";
                        disableDraw();
                        enablePencil();
                    }
                };

                return wrapper;
            }
        });

        map.addControl(new PencilControl());


        function disableDraw() {
            document.querySelectorAll('.leaflet-draw-toolbar a').forEach(btn => {
                btn.classList.remove('leaflet-draw-toolbar-button-enabled');
            });
        }

        function enablePencil() {
            document.getElementById('panel').style.display = 'none'; // Oculta panel
            map.dragging.disable();
            map.on('mousedown touchstart', startDrawing);
            map.on('mousemove touchmove', draw);
            map.on('mouseup touchend', endDrawing);
        }

        function disablePencil() {
            document.getElementById('panel').style.display = 'block'; // Muestra panel
            map.dragging.enable();
            map.off('mousedown touchstart', startDrawing);
            map.off('mousemove touchmove', draw);
            map.off('mouseup touchend', endDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            const latlng = e.latlng || map.mouseEventToLatLng(e.originalEvent);
            const color = selectedColor || 'black';
            currentLine = L.polyline([latlng], {
                color: color,
                weight: 2
            }).addTo(drawnItems);
        }

        function draw(e) {
            if (!isDrawing || !currentLine) return;
            const latlng = e.latlng || map.mouseEventToLatLng(e.originalEvent);
            currentLine.addLatLng(latlng);
        }

        function endDrawing() {
            isDrawing = false;

            if (currentLine) {
                const geojson = currentLine.toGeoJSON();

                drawingsRef.add({
                    type: "pencil",
                    geometry: geojson.geometry,
                    style: {
                        color: selectedColor,
                        weight: 2
                    },
                });
            }

            currentLine = null;
        }


        const toggleBtn = document.getElementById('toggle-panel');
        const panel = document.getElementById('panel');
        let panelVisible = true;

        toggleBtn.addEventListener('click', () => {
            panelVisible = !panelVisible;
            panel.style.display = panelVisible ? 'block' : 'none';
            toggleBtn.textContent = panelVisible ? 'Pj' : 'pj';
        });



    </script>
</body>

</html>
