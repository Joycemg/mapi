<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>Mapa Apocalipsis en Tiempo Real</title>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0" />

    <!-- Leaflet -->
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Leaflet Draw -->
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
    <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        html,
        body,
        #map {
            margin: 0;
            height: 100%;
        }

        .filtered-tile {
            filter: grayscale(100%) brightness(60%) contrast(140%) hue-rotate(30deg) sepia(40%) saturate(130%) blur(0.3px);
        }

        #panel {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            max-height: 40%;
            overflow-y: auto;
            background: rgba(20, 20, 20, 0.95);
            color: white;
            padding: 10px;
            font-family: sans-serif;
            z-index: 1000;
        }

        #add-controls {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 10px;
            gap: 5px;
        }

        .character-entry {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #333;
            padding: 4px 8px;
            margin: 4px 0;
            border-radius: 4px;
        }

        .character-entry span {
            flex: 1;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        button {
            cursor: pointer;
        }

        .marker-label {
            background: black;
            color: white;
            padding: 2px 4px;
            font-size: 10px;
            border-radius: 4px;
        }

        #blood-frame {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: url('marco.png') no-repeat center center;
            background-size: cover;
            z-index: 999;
            opacity: 0.4;
        }

        .custom-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1001;
            background: rgba(0, 0, 0, 0.7);
            padding: 6px 10px;
            border-radius: 6px;
            display: flex;
            gap: 8px;
            color: white;
        }

        .leaflet-bar a.custom-pencil {
            background-color: white;
            font-size: 18px;
            line-height: 26px;
            text-align: center;
        }

        .leaflet-bar a.custom-pencil.active {
            background-color: #ddd;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <div id="blood-frame"></div>

    <div class="custom-controls">
        <label for="pencilColor">Color del l√°piz:</label>
        <select id="pencilColor">
            <option value="black">üñ§ Negro</option>
            <option value="white">ü§ç Blanco</option>
            <option value="red">‚ù§Ô∏è Rojo</option>
        </select>
    </div>

    <div id="panel">
        <div id="add-controls">
            <input type="text"
                   id="name"
                   placeholder="Nombre del personaje" />
            <input type="color"
                   id="color"
                   value="#ff0000" />
            <button onclick="addCharacter()">Agregar personaje</button>
        </div>
        <div id="character-list"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCP1VddmMF11_QwZGMx6ILHbOpSVhYIMk4",
            authDomain: "mapaj-6017a.firebaseapp.com",
            projectId: "mapaj-6017a",
            storageBucket: "mapaj-6017a.firebasestorage.app",
            messagingSenderId: "411493901671",
            appId: "1:411493901671:web:5e732ecacbb43226a4fbc2"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const charactersRef = db.collection("characters");

        const map = L.map('map', {
            center: [-34.6037, -58.3816],
            zoom: 4,
            minZoom: 4
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            className: 'filtered-tile',
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const markers = {};
        const characterEntries = {};

        function renderCharacter(doc) {
            const data = doc.data();
            const id = doc.id;

            if (!markers[id]) {
                const markerHtml = document.createElement('div');
                markerHtml.style.backgroundColor = data.color;
                markerHtml.style.width = '20px';
                markerHtml.style.height = '20px';
                markerHtml.style.borderRadius = '50%';
                markerHtml.style.border = '2px solid black';
                markerHtml.style.position = 'relative';

                const label = document.createElement('div');
                label.className = 'marker-label';
                label.textContent = data.name;
                label.style.position = 'absolute';
                label.style.top = '-20px';
                label.style.left = '-10px';
                markerHtml.appendChild(label);

                const icon = L.divIcon({ html: markerHtml.outerHTML, className: '' });
                const marker = L.marker([data.lat, data.lng], { icon: icon, draggable: true }).addTo(map);

                marker.on('dragend', function (e) {
                    const pos = e.target.getLatLng();
                    charactersRef.doc(id).update({ lat: pos.lat, lng: pos.lng });
                });

                markers[id] = marker;
            } else {
                markers[id].setLatLng([data.lat, data.lng]);
            }

            if (!characterEntries[id]) {
                const entry = document.createElement('div');
                entry.className = 'character-entry';
                entry.id = `entry-${id}`;
                entry.innerHTML = `
          <span>${data.name}</span>
          <button onclick="locateCharacter('${id}')">üìç</button>
          <button onclick="deleteCharacter('${id}')">‚ùå</button>
        `;
                document.getElementById('character-list').appendChild(entry);
                characterEntries[id] = entry;
            } else {
                characterEntries[id].querySelector('span').textContent = data.name;
            }
        }

        function locateCharacter(id) {
            if (markers[id]) {
                map.setView(markers[id].getLatLng(), 17);
            }
        }

        function deleteCharacter(id) {
            charactersRef.doc(id).delete();
        }

        charactersRef.onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                const id = change.doc.id;
                if (change.type === 'added' || change.type === 'modified') {
                    renderCharacter(change.doc);
                } else if (change.type === 'removed') {
                    if (markers[id]) {
                        map.removeLayer(markers[id]);
                        delete markers[id];
                    }
                    if (characterEntries[id]) {
                        characterEntries[id].remove();
                        delete characterEntries[id];
                    }
                }
            });
        });

        function addCharacter() {
            const name = document.getElementById('name').value || 'Sin nombre';
            const color = document.getElementById('color').value;
            const center = map.getCenter();
            charactersRef.add({
                name: name,
                color: color,
                lat: center.lat,
                lng: center.lng
            });
            document.getElementById('name').value = '';
        }

        // === Leaflet Draw ===
        const drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        const drawControl = new L.Control.Draw({
            draw: {
                polygon: false,
                polyline: false,
                marker: false,
                circlemarker: false,
                rectangle: { shapeOptions: { color: '#ffbb00' } },
                circle: { shapeOptions: { color: '#00cc99' } }
            },
            edit: {
                featureGroup: drawnItems,
                remove: true
            }
        });
        map.addControl(drawControl);

        map.on(L.Draw.Event.CREATED, function (e) {
            drawnItems.addLayer(e.layer);
        });

        // === L√°piz personalizado ===
        let isDrawing = false;
        let currentLine = null;

        const PencilControl = L.Control.extend({
            options: { position: 'topleft' },
            onAdd: function () {
                const container = L.DomUtil.create('div', 'leaflet-bar');
                const button = L.DomUtil.create('a', 'custom-pencil', container);
                button.innerHTML = '‚úèÔ∏è';
                button.href = '#';

                button.onclick = function (e) {
                    e.preventDefault();
                    if (button.classList.contains('active')) {
                        button.classList.remove('active');
                        disablePencil();
                    } else {
                        button.classList.add('active');
                        disableDraw();
                        enablePencil();
                    }
                };
                return container;
            }
        });
        map.addControl(new PencilControl());

        function disableDraw() {
            document.querySelectorAll('.leaflet-draw-toolbar a').forEach(btn => {
                btn.classList.remove('leaflet-draw-toolbar-button-enabled');
            });
        }

        function enablePencil() {
            map.dragging.disable();
            map.on('mousedown', startDrawing);
            map.on('mousemove', draw);
            map.on('mouseup', endDrawing);
            map.on('touchstart', startDrawing);
            map.on('touchmove', draw);
            map.on('touchend', endDrawing);
        }

        function disablePencil() {
            map.dragging.enable();
            map.off('mousedown', startDrawing);
            map.off('mousemove', draw);
            map.off('mouseup', endDrawing);
            map.off('touchstart', startDrawing);
            map.off('touchmove', draw);
            map.off('touchend', endDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            const latlng = e.latlng || map.mouseEventToLatLng(e.originalEvent);
            const color = document.getElementById('pencilColor').value || 'black';
            currentLine = L.polyline([latlng], {
                color: color,
                weight: 3
            }).addTo(drawnItems);
        }

        function draw(e) {
            if (!isDrawing || !currentLine) return;
            const latlng = e.latlng || map.mouseEventToLatLng(e.originalEvent);
            currentLine.addLatLng(latlng);
        }

        function endDrawing() {
            isDrawing = false;
            currentLine = null;
        }
    </script>
</body>

</html>


